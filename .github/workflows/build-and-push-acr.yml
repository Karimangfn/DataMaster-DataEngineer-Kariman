run-name: Build and Push to ACR 
name: Build and Push to ACR

on:
  workflow_dispatch:
  push:
    branches:
      - develop
      - main
    paths:
      - 'microservices/**/VERSION'

jobs:
  detect_services:
    name: ðŸ” Detect Microservices
    runs-on: ubuntu-latest
    if: github.event.head_commit.message != 'Initial commit'
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ§  Identify microservices with VERSION file
        id: set-matrix
        run: |
          echo "ðŸ”Ž Searching for VERSION files in microservices/"
          all_services=$(find microservices -type f -name 'VERSION' | xargs -n1 dirname | sort -u)

          if [ -z "$all_services" ]; then
            echo "âš ï¸ No VERSION files found under microservices/. Exiting."
            echo 'matrix=[]' >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸ“ Detected services:"
          echo "$all_services"

          json_array=$(printf '%s\n' $all_services | jq -R . | jq -s -c .)
          echo "matrix=$json_array" >> $GITHUB_OUTPUT

  filter_each_service:
    name: ðŸ§ª Filter Services to Build
    runs-on: ubuntu-latest
    needs: detect_services
    strategy:
      matrix:
        service_path: ${{ fromJson(needs.detect_services.outputs.matrix) }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ github.event.inputs.azure_credentials || secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Login to ACR
        run: |
          acr_name="${{ github.event.inputs.acr_name || secrets.ACR_NAME }}"
          az acr login --name $acr_name

      - name: ðŸ“– Read version and check ACR tags
        id: check
        run: |
          acr_name="${{ github.event.inputs.acr_name || secrets.ACR_NAME }}"
          version=$(cat ${{ matrix.service_path }}/VERSION)
          image_name=$(basename "${{ matrix.service_path }}")

          set +e
          tags=$(az acr repository show-tags --name $acr_name --repository $image_name --query "[?contains(@, '$version')]" 2>/dev/null)
          exit_code=$?
          set -e

          mkdir -p build_tmp

          if [[ $exit_code -ne 0 || -z "$tags" || "$tags" == "[]" ]]; then
            echo "${{ matrix.service_path }}" >> build_tmp/services_to_build.txt
            echo "{\"service\":\"$image_name\", \"version\":\"$version\", \"status\":\"to_build\"}" > build_tmp/status.json
          else
            echo "{\"service\":\"$image_name\", \"version\":\"$version\", \"status\":\"skipped\"}" > build_tmp/status.json
          fi

      - name: ðŸ·ï¸ Set safe artifact name
        id: set-name
        run: |
          safe_name=$(echo "${{ matrix.service_path }}" | tr '/' '_')
          echo "safe_name=status_${safe_name}" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload status artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set-name.outputs.safe_name }}
          path: build_tmp/*
          if-no-files-found: warn
          compression-level: 6

  aggregate_filter:
    name: ðŸ—ƒï¸ Aggregate Filtered Services
    runs-on: ubuntu-latest
    needs: filter_each_service
    outputs:
      filtered_matrix: ${{ steps.set_output.outputs.filtered_matrix }}
    steps:
      - name: ðŸ“¥ Download all status artifacts
        uses: actions/download-artifact@v4
        with:
          path: tmp_status

      - name: ðŸ§¹ Aggregate services_to_build.txt into final_matrix.json
        run: |
          mkdir -p build_tmp
          if [ -d tmp_status ]; then
            find tmp_status -name "services_to_build.txt" -exec cat {} + | sort -u | jq -R . | jq -s -c . > build_tmp/final_matrix.json
          else
            echo '[]' > build_tmp/final_matrix.json
          fi
          cat build_tmp/final_matrix.json

      - name: ðŸš¨ Debug filtered matrix
        run: cat build_tmp/final_matrix.json

      - id: set_output
        run: echo "filtered_matrix=$(cat build_tmp/final_matrix.json)" >> $GITHUB_OUTPUT

  generate_summary:
    name: ðŸ“‹ Generate Build
    runs-on: ubuntu-latest
    needs: [filter_each_service, aggregate_filter]
    steps:
      - name: ðŸ“¥ Download all status artifacts
        uses: actions/download-artifact@v4
        with:
          path: tmp_status
  
      - name: ðŸ§© Merge status files
        run: |
          find tmp_status -name "status.json" -exec cat {} + | jq -s '.' > services_status.json
  
      - name: ðŸ“‹ Create detailed build summary
        run: |
          echo "## ðŸš€ Microservices Deployment to Azure Container Registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
  
          total=$(jq length services_status.json)
          to_build=$(jq '[.[] | select(.status == "to_build")] | length' services_status.json)
          skipped=$(jq '[.[] | select(.status == "skipped")] | length' services_status.json)
  
          echo "**Detected services:** $total" >> $GITHUB_STEP_SUMMARY
          echo "**New version to deploy detected:** $to_build ðŸ“¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
  
          echo "### ðŸ“¦ Service Details:" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
  
          cat services_status.json | jq -c '.[]' | while read service; do
            name=$(echo $service | jq -r '.service')
            version=$(echo $service | jq -r '.version')
            status=$(echo $service | jq -r '.status')
  
            if [ "$status" = "skipped" ]; then
              echo "| $name | $version | â­ï¸ Version already exists in ACR |" >> $GITHUB_STEP_SUMMARY
            elif [ "$status" = "to_build" ]; then
              echo "| $name | $version | ðŸ“¤ Deploying new version to ACR |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $name | $version | âš ï¸ Unknown status |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  build_and_push:
    name: ðŸš€ Build and Push
    runs-on: ubuntu-latest
    needs: aggregate_filter
    if: needs.aggregate_filter.outputs.filtered_matrix != '[]'
    strategy:
      matrix:
        service_path: ${{ fromJson(needs.aggregate_filter.outputs.filtered_matrix) }}
    steps:
      - name: Show current service
        run: echo "Building service ${{ matrix.service_path }}"

      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ github.event.inputs.azure_credentials || secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Login to ACR
        run: |
          acr_name="${{ github.event.inputs.acr_name || secrets.ACR_NAME }}"
          az acr login --name $acr_name

      - name: ðŸ“– Read service version
        id: version
        run: |
          version=$(cat ${{ matrix.service_path }}/VERSION)
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ðŸ—ï¸ Build Docker image
        run: |
          acr_name="${{ github.event.inputs.acr_name || secrets.ACR_NAME }}"
          version="${{ steps.version.outputs.version }}"
          image_name=$(basename "${{ matrix.service_path }}")

          echo "ðŸ—ï¸ Building $acr_name.azurecr.io/$image_name:$version"
          docker build -t $acr_name.azurecr.io/$image_name:$version -f ${{ matrix.service_path }}/Dockerfile ${{ matrix.service_path }}/

      - name: ðŸ“¤ Push Docker image
        run: |
          acr_name="${{ github.event.inputs.acr_name || secrets.ACR_NAME }}"
          version="${{ steps.version.outputs.version }}"
          image_name=$(basename "${{ matrix.service_path }}")

          echo "ðŸ“¤ Pushing $acr_name.azurecr.io/$image_name:$version"
          docker push $acr_name.azurecr.io/$image_name:$version

  build_summary:
    name: ðŸ“ Build Summary
    runs-on: ubuntu-latest
    needs: filter_each_service
    steps:
      - name: ðŸ“¥ Download all status artifacts
        uses: actions/download-artifact@v4
        with:
          path: tmp_status

      - name: ðŸ§© Merge status files
        run: |
          mkdir -p tmp_status
          find tmp_status -name "status.json" -exec cat {} + | jq -s '.' > services_status.json
          cat services_status.json

      - name: ðŸ“‹ Create Build Summary
        run: |
          echo "## ðŸš€ Microservices Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          total=$(jq length services_status.json)
          to_build=$(jq '[.[] | select(.status == "to_build")] | length' services_status.json)
          skipped=$(jq '[.[] | select(.status == "skipped")] | length' services_status.json)

          echo "**Detected services:** $total" >> $GITHUB_STEP_SUMMARY
          echo "**New versions to deploy:** $to_build ðŸ“¤" >> $GITHUB_STEP_SUMMARY
          echo "**Skipped (already on ACR):** $skipped â­ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“¦ Service Details" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          cat services_status.json | jq -c '.[]' | while read -r service; do
            name=$(echo "$service" | jq -r '.service')
            version=$(echo "$service" | jq -r '.version')
            status=$(echo "$service" | jq -r '.status')

            case "$status" in
              to_build)
                echo "| $name | $version | ðŸ“¤ Deploying |" >> $GITHUB_STEP_SUMMARY
                ;;
              skipped)
                echo "| $name | $version | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "| $name | $version | âš ï¸ Unknown |" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          done
