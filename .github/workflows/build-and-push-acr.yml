run-name: Build and Push to ACR
name: Build and Push to ACR

on:
  workflow_dispatch:
  push:
    branches:
      - develop
    paths:
      - 'microservice/**/VERSION'

jobs:
  detect_services:
    name: ğŸ” Detect Changed Microservices
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§  Identify modified microservices
        id: set-matrix
        run: |
          echo "ğŸ” Searching for changed VERSION files in microservice/"
          changed_services=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^microservice/.*/VERSION' | xargs -n1 dirname | sort -u)
          echo "ğŸ“ Detected services:"
          echo "$changed_services"

          json_array=$(printf '%s\n' $changed_services | jq -R . | jq -s .)
          echo "matrix=$json_array" >> $GITHUB_OUTPUT
        shell: bash

  build_and_push:
    name: ğŸš€ Build and Push (${{ matrix.service_path }})
    runs-on: ubuntu-latest
    needs: detect_services
    strategy:
      matrix:
        service_path: ${{ fromJson(needs.detect_services.outputs.matrix) }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ github.event.inputs.azure_credentials || secrets.AZURE_CREDENTIALS }}

      - name: ğŸ” Login to ACR
        run: |
          acr_name="${{ github.event.inputs.acr_name || secrets.ACR_NAME }}"
          echo "ğŸ” Logging into ACR: $acr_name"
          az acr login --name $acr_name

      - name: ğŸ“– Read service version
        id: version
        run: |
          version=$(cat ${{ matrix.service_path }}/VERSION)
          echo "ğŸ“¦ Service: ${{ matrix.service_path }}"
          echo "ğŸ·ï¸ Version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ğŸ” Check if image exists in ACR
        id: check
        run: |
          acr_name="${{ github.event.inputs.acr_name || secrets.ACR_NAME }}"
          version="${{ steps.version.outputs.version }}"
          image_name=$(basename "${{ matrix.service_path }}")
          echo "ğŸ” Checking if image $image_name:$version exists in ACR $acr_name..."

          if az acr repository show-tags --name $acr_name --repository $image_name --query "[?contains(@, '$version')]" | grep -q "$version"; then
            echo "âœ… Image $image_name:$version already exists. Skipping build."
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ†• Image $image_name:$version not found. Build required."
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ—ï¸ Build Docker image
        if: steps.check.outputs.skip_build != 'true'
        run: |
          acr_name="${{ github.event.inputs.acr_name || secrets.ACR_NAME }}"
          version="${{ steps.version.outputs.version }}"
          image_name=$(basename "${{ matrix.service_path }}")

          echo "ğŸ—ï¸ Building image $acr_name.azurecr.io/$image_name:$version"
          docker build -t $acr_name.azurecr.io/$image_name:$version -f ${{ matrix.service_path }}/Dockerfile ${{ matrix.service_path }}/

      - name: ğŸ“¤ Push Docker image
        if: steps.check.outputs.skip_build != 'true'
        run: |
          acr_name="${{ github.event.inputs.acr_name || secrets.ACR_NAME }}"
          version="${{ steps.version.outputs.version }}"
          image_name=$(basename "${{ matrix.service_path }}")

          echo "ğŸ“¤ Pushing image $acr_name.azurecr.io/$image_name:$version"
          docker push $acr_name.azurecr.io/$image_name:$version
