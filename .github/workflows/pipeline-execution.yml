run-name: Orchestrate Data Pipeline
name: Orchestrate Data Pipeline

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  detect_services:
    name: üîç Detect Microservices
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - id: detect
        run: |
          echo "üì¶ Detectando microservi√ßos com Helm charts..."
          services=$(find microservices -type f -path "*/helm/Chart.yaml" -exec dirname {} \; | awk -F'/' '{print $2}' | sort -u)
          
          if [ -z "$services" ]; then
            echo "‚ùå Nenhum microservi√ßo encontrado!"
            echo 'matrix=[]' >> $GITHUB_OUTPUT
            exit 0
          fi

          json_array=$(printf '%s\n' $services | jq -R . | jq -s -c .)
          echo "matrix=$json_array" >> $GITHUB_OUTPUT
          echo "‚úÖ Detectados: $json_array"

  aks-jobs:
    name: üß© Run AKS Jobs (with Image Validation)
    runs-on: ubuntu-latest
    needs: detect_services
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect_services.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ‚öôÔ∏è Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_NAME }} \
            --admin

      - name: üßæ Validate Image in ACR before Helm Job
        id: validate
        run: |
          service="${{ matrix.service }}"
          version_file="microservices/$service/VERSION"

          if [ ! -f "$version_file" ]; then
            echo "‚ö†Ô∏è Nenhum arquivo VERSION encontrado para $service. Pulando..."
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          version=$(cat "$version_file")
          acr_name="${{ secrets.ACR_NAME }}"

          echo "üîç Validando imagem $acr_name.azurecr.io/$service:$version ..."
          if az acr repository show-tags --name "$acr_name" --repository "$service" --query "[?contains(@, '$version')]" -o tsv | grep -q "$version"; then
            echo "‚úÖ Imagem encontrada no ACR."
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Imagem $acr_name.azurecr.io/$service:$version n√£o encontrada no ACR."
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ Execute Helm Job for ${{ matrix.service }}
        if: steps.validate.outputs.valid == 'true'
        run: |
          echo "üß© Executando Helm job para ${{ matrix.service }}"
          helm upgrade --install ${{ matrix.service }} microservices/${{ matrix.service }}/helm \
            --reuse-values \
            --set job.enabled=true

          echo "‚è≥ Aguardando job terminar..."
          kubectl wait --for=condition=complete job/${{ matrix.service }}-job --timeout=900s || {
            echo "‚ùå Job ${{ matrix.service }} falhou ou expirou"
            kubectl logs job/${{ matrix.service }}-job || true
            exit 1
          }

      - name: üßæ Record Result
        if: always()
        run: |
          mkdir -p results
          status="‚ùå Failed"
          if [[ "${{ steps.validate.outputs.valid }}" == "true" ]]; then
            if kubectl get job ${{ matrix.service }}-job &>/dev/null; then
              status="‚úÖ Success"
            fi
          else
            status="‚ö†Ô∏è Skipped (Image Missing)"
          fi
          echo "{\"service\":\"${{ matrix.service }}\", \"status\":\"$status\"}" > results/${{ matrix.service }}.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aks-results
          path: results/

  databricks-job:
    name: üß† Run Databricks Job (AAD Login)
    runs-on: ubuntu-latest
    needs: aks-jobs
    steps:
      - uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üì¶ Install Databricks CLI
        run: pip install databricks-cli --upgrade

      - name: ‚öôÔ∏è Configure Databricks CLI (AAD Auth)
        env:
          DATABRICKS_WORKSPACE_URL: ${{ secrets.DATABRICKS_WORKSPACE_URL }}
        run: |
          mkdir -p ~/.databricks
          cat <<EOF > ~/.databricks/config
          [DEFAULT]
          host = $DATABRICKS_WORKSPACE_URL
          auth_type = azure-cli
          EOF

      - name: üöÄ Execute Databricks Job
        env:
          JOB_ID: ${{ secrets.DATABRICKS_JOB_ID }}
        run: |
          echo "‚ñ∂Ô∏è Rodando job Databricks $JOB_ID"
          RUN_ID=$(databricks jobs run-now --job-id "$JOB_ID" --output | jq -r '.run_id')
          databricks runs wait --run-id "$RUN_ID"
          echo "‚úÖ Databricks job finalizado!"

  summary:
    name: üìã Pipeline Summary
    runs-on: ubuntu-latest
    needs: [aks-jobs, databricks-job]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: aks-results
          path: results/

      - run: |
          echo "## üöÄ AKS Job Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY

          for f in results/*.json; do
            svc=$(jq -r '.service' "$f")
            st=$(jq -r '.status' "$f")
            echo "| $svc | $st |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üß† Databricks Job" >> $GITHUB_STEP_SUMMARY
          echo "- Job ID: **${{ secrets.DATABRICKS_JOB_ID }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Workspace: **${{ secrets.DATABRICKS_WORKSPACE_URL }}**" >> $GITHUB_STEP_SUMMARY
